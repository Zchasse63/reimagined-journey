---
/**
 * MarketDashboard.astro
 * Full market intelligence section with commodity cards, freight info, and email capture
 *
 * Props:
 * - city: string - Target city name
 * - marketData: MarketData - Market data from API or fallback
 * - distanceFromAtlanta: number - Miles from Atlanta for trucking estimate
 */
import type { MarketData } from '@/types/market-data';
import { formatLastUpdated } from '@/lib/market-data';
import CommodityCard from './CommodityCard.astro';
import MicroEmailCapture from './MicroEmailCapture.astro';

interface Props {
  city: string;
  marketData: MarketData;
  distanceFromAtlanta: number;
}

const { city, marketData, distanceFromAtlanta } = Astro.props;

// Trucking cost calculation
const COST_PER_MILE = 2.50;
const truckingEstimate = distanceFromAtlanta * COST_PER_MILE;
const formattedTruckingEstimate = new Intl.NumberFormat('en-US', {
  style: 'currency',
  currency: 'USD',
  minimumFractionDigits: 0,
  maximumFractionDigits: 0,
}).format(truckingEstimate);

// Ocean freight mock data (realistic rates for container shipping)
const oceanFreightRoutes = [
  {
    route: 'China \u2192 Savannah',
    rate: 2850,
    change: -4.2,
    unit: '40ft',
  },
  {
    route: 'Vietnam \u2192 Savannah',
    rate: 3120,
    change: 1.8,
    unit: '40ft',
  },
];

// Format the last updated time
const formattedTime = formatLastUpdated(marketData.updatedAt);

// Helper to get trend display for ocean freight
const getFreightTrendDisplay = (change: number) => {
  if (change < -0.5) {
    return {
      arrow: '\u2193',
      colorClass: 'text-green-600',
      bgClass: 'bg-green-100',
    };
  }
  if (change > 0.5) {
    return {
      arrow: '\u2191',
      colorClass: 'text-red-600',
      bgClass: 'bg-red-100',
    };
  }
  return {
    arrow: '\u2192',
    colorClass: 'text-slate-500',
    bgClass: 'bg-slate-100',
  };
};

// Check if sugar data is available (placeholder for future expansion)
const hasSugarData = false; // Set to true when sugar data is added to MarketData
---

<section class="bg-white py-16">
  <div class="container-wide">
    <!-- Section Header -->
    <div class="text-center mb-12">
      <h2 class="text-3xl md:text-4xl font-bold text-slate-900 mb-4">
        Today's Market Intelligence for {city} Food Service
      </h2>
      <p class="text-lg text-slate-600 max-w-3xl mx-auto">
        Real-time commodity prices and logistics costs that impact your bottom line.
        Updated daily from USDA, EIA, and industry sources.
      </p>
    </div>

    <!-- Cards Grid -->
    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12">
      <!-- Poultry Card -->
      <CommodityCard
        title="Poultry"
        icon={'\u{1F357}'}
        items={marketData.poultry.items}
        source={marketData.poultry.source}
      />

      <!-- Beef Card -->
      <CommodityCard
        title="Beef"
        icon={'\u{1F969}'}
        items={marketData.beef.items}
        source={marketData.beef.source}
      />

      <!-- Cooking Oil Card -->
      <CommodityCard
        title="Cooking Oil"
        icon={'\u{1FAD2}'}
        items={marketData.cookingOil.items}
        source={marketData.cookingOil.source}
      />

      <!-- Sugar Card (conditionally rendered) -->
      {hasSugarData && (
        <CommodityCard
          title="Sugar"
          icon={'\u{1F36C}'}
          items={[
            { name: 'Granulated', price: 0.45, unit: 'lb', change: -0.8 },
            { name: 'Brown', price: 0.52, unit: 'lb', change: 0.3 },
          ]}
          source="USDA ERS"
        />
      )}

      <!-- Ocean Freight Card (custom) -->
      <div class="bg-slate-50 rounded-xl p-6 border border-slate-200">
        <div class="flex items-center gap-2 mb-4">
          <span class="text-2xl" aria-hidden="true">{'\u{1F6A2}'}</span>
          <h3 class="text-lg font-semibold text-slate-900">Ocean Freight</h3>
        </div>

        <div class="space-y-3">
          {oceanFreightRoutes.map((route) => {
            const trend = getFreightTrendDisplay(route.change);
            return (
              <div class="flex items-center justify-between py-2 border-b border-slate-200 last:border-b-0">
                <div class="text-slate-700 font-medium text-sm">{route.route}</div>
                <div class="flex items-center gap-2">
                  <span class="text-slate-900 font-semibold tabular-nums">
                    ${route.rate.toLocaleString()}
                    <span class="text-slate-500 text-xs font-normal">/{route.unit}</span>
                  </span>
                  <span
                    class={`inline-flex items-center gap-1 px-2 py-0.5 rounded text-sm font-medium ${trend.bgClass} ${trend.colorClass}`}
                    title={`${route.change >= 0 ? '+' : ''}${route.change.toFixed(1)}% vs last week`}
                  >
                    {trend.arrow} {Math.abs(route.change).toFixed(1)}%
                  </span>
                </div>
              </div>
            );
          })}
        </div>

        <div class="mt-4 pt-3 border-t border-slate-200">
          <p class="text-xs text-slate-500">
            Source: Freightos Baltic Index
          </p>
        </div>
      </div>

      <!-- Trucking Card (custom) -->
      <div class="bg-slate-50 rounded-xl p-6 border border-slate-200">
        <div class="flex items-center gap-2 mb-4">
          <span class="text-2xl" aria-hidden="true">{'\u{1F69A}'}</span>
          <h3 class="text-lg font-semibold text-slate-900">Trucking Estimate</h3>
        </div>

        <div class="space-y-4">
          <div class="bg-white rounded-lg p-4 border border-slate-200">
            <div class="text-sm text-slate-600 mb-1">Atlanta {'\u2192'} {city}</div>
            <div class="text-2xl font-bold text-slate-900">
              ~{formattedTruckingEstimate}
            </div>
            <div class="text-sm text-slate-500 mt-1">
              {distanceFromAtlanta.toLocaleString()} miles
            </div>
          </div>

          <div class="flex items-center justify-between text-sm">
            <span class="text-slate-600">Rate per mile</span>
            <span class="font-medium text-slate-900">${COST_PER_MILE.toFixed(2)}</span>
          </div>

          <div class="flex items-center justify-between text-sm">
            <span class="text-slate-600">Current diesel</span>
            <span class="font-medium text-slate-900">
              ${marketData.diesel.price.toFixed(2)}/gal
            </span>
          </div>
        </div>

        <div class="mt-4 pt-3 border-t border-slate-200">
          <p class="text-xs text-slate-500">
            Estimate based on DAT Freight & Analytics
          </p>
        </div>
      </div>
    </div>

    <!-- Footer with sources and email capture -->
    <div class="space-y-6">
      <!-- Sources and timestamp -->
      <div class="text-center">
        <p class="text-sm text-slate-500">
          Last updated: {formattedTime} | Data sources: USDA LMPR, USDA ERS, EIA, Freightos Baltic Index, DAT
        </p>
      </div>

      <!-- Email capture -->
      <div class="max-w-2xl mx-auto">
        <MicroEmailCapture
          headline="Get weekly market updates"
          subtext="Join 2,400+ food service operators who stay ahead of market moves. Unsubscribe anytime."
          buttonText="Subscribe"
          source="market_dashboard"
        />
      </div>
    </div>
  </div>
</section>
