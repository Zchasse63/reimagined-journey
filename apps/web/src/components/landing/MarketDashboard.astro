---
/**
 * MarketDashboard.astro
 * Full market intelligence section with commodity cards, freight info, and tariffs
 *
 * Props:
 * - city: string - Target city name
 * - marketData: MarketData - Market data from API or fallback
 */
import type { MarketData } from '@/types/market-data';
import { formatLastUpdated } from '@/lib/market-data';
import CommodityCard from './CommodityCard.astro';

interface Props {
  city: string;
  marketData: MarketData;
}

const { city, marketData } = Astro.props;

// Format the last updated time
const formattedTime = formatLastUpdated(marketData.updatedAt);

// Helper to get trend display for prices
const getTrendDisplay = (change: number) => {
  if (change < -0.5) {
    return {
      arrow: '\u2193',
      colorClass: 'text-green-600',
      bgClass: 'bg-green-100',
    };
  }
  if (change > 0.5) {
    return {
      arrow: '\u2191',
      colorClass: 'text-red-600',
      bgClass: 'bg-red-100',
    };
  }
  return {
    arrow: '\u2192',
    colorClass: 'text-slate-500',
    bgClass: 'bg-slate-100',
  };
};

// Check if new data sections are available
const hasSugarData = marketData.sugar?.items?.length > 0;
const hasOceanFreightData = marketData.oceanFreight?.routes?.length > 0;
const hasTariffData = marketData.tariffs?.examples?.length > 0;
---

<section class="bg-white py-16">
  <div class="container-wide">
    <!-- Section Header -->
    <div class="text-center mb-12">
      <h2 class="text-3xl md:text-4xl font-bold text-slate-900 mb-4">
        Today's Market Intelligence for {city} Food Service
      </h2>
      <p class="text-lg text-slate-600 max-w-3xl mx-auto">
        Real-time commodity prices, freight rates, and import costs that impact your bottom line.
        Updated daily from USDA, EIA, Freightos, and USITC sources.
      </p>
    </div>

    <!-- Commodity Cards Grid -->
    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
      <!-- Poultry Card -->
      <CommodityCard
        title="Poultry"
        icon={'\u{1F357}'}
        items={marketData.poultry.items}
        source={marketData.poultry.source}
      />

      <!-- Beef Card -->
      <CommodityCard
        title="Beef"
        icon={'\u{1F969}'}
        items={marketData.beef.items}
        source={marketData.beef.source}
      />

      <!-- Cooking Oil Card -->
      <CommodityCard
        title="Cooking Oil"
        icon={'\u{1FAD2}'}
        items={marketData.cookingOil.items}
        source={marketData.cookingOil.source}
      />

      <!-- Sugar Card -->
      {hasSugarData && (
        <CommodityCard
          title="Sugar & Sweeteners"
          icon={'\u{1F36C}'}
          items={marketData.sugar.items}
          source={marketData.sugar.source}
        />
      )}
    </div>

    <!-- Freight & Logistics Section -->
    <div class="mb-8">
      <h3 class="text-xl font-semibold text-slate-800 mb-4 flex items-center gap-2">
        <span class="text-2xl">üì¶</span> Freight & Logistics
      </h3>
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Ocean Freight Card -->
        {hasOceanFreightData && (
          <div class="bg-gradient-to-br from-blue-50 to-slate-50 rounded-xl p-6 border border-blue-200">
            <div class="flex items-center gap-2 mb-4">
              <span class="text-2xl" aria-hidden="true">{'\u{1F6A2}'}</span>
              <h4 class="text-lg font-semibold text-slate-900">Ocean Freight</h4>
            </div>

            <div class="space-y-3">
              {marketData.oceanFreight.routes.slice(0, 4).map((route) => {
                const trend = getTrendDisplay(route.change);
                return (
                  <div class="flex items-center justify-between py-2 border-b border-slate-200 last:border-b-0">
                    <div>
                      <div class="text-slate-700 font-medium text-sm">
                        {route.origin.split(',')[0]} ‚Üí {route.destination.split(',')[0]}
                      </div>
                      {route.transitDays && (
                        <div class="text-xs text-slate-500">{route.transitDays} days</div>
                      )}
                    </div>
                    <div class="flex items-center gap-2">
                      <span class="text-slate-900 font-semibold tabular-nums text-sm">
                        ${route.price.toLocaleString()}
                      </span>
                      <span
                        class={`inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium ${trend.bgClass} ${trend.colorClass}`}
                        title={`${route.change >= 0 ? '+' : ''}${route.change.toFixed(1)}% vs last week`}
                      >
                        {trend.arrow}
                      </span>
                    </div>
                  </div>
                );
              })}
            </div>

            <div class="mt-4 pt-3 border-t border-slate-200">
              <p class="text-xs text-slate-500">
                Source: {marketData.oceanFreight.source}
              </p>
            </div>
          </div>
        )}

        <!-- Diesel Card -->
        <div class="bg-gradient-to-br from-slate-50 to-slate-100 rounded-xl p-6 border border-slate-200">
          <div class="flex items-center gap-2 mb-4">
            <span class="text-2xl" aria-hidden="true">‚õΩ</span>
            <h4 class="text-lg font-semibold text-slate-900">Diesel Fuel</h4>
          </div>

          <div class="space-y-4">
            <div class="text-center py-4">
              <div class="text-4xl font-bold text-slate-900">
                ${marketData.diesel.price.toFixed(2)}
                <span class="text-lg font-normal text-slate-500">/gal</span>
              </div>
              {(() => {
                const dieselChange = ((marketData.diesel.price - marketData.diesel.previousWeek) / marketData.diesel.previousWeek * 100);
                const trend = getTrendDisplay(dieselChange);
                return (
                  <div class={`mt-2 inline-flex items-center gap-1 px-2 py-1 rounded ${trend.bgClass} ${trend.colorClass}`}>
                    {trend.arrow} {Math.abs(dieselChange).toFixed(1)}% vs last week
                  </div>
                );
              })()}
            </div>

            <div class="text-sm text-center text-slate-600">
              {marketData.diesel.region}
            </div>
          </div>

          <div class="mt-4 pt-3 border-t border-slate-200">
            <p class="text-xs text-slate-500">
              Source: EIA Weekly Petroleum Status Report
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Import Tariffs Section -->
    {hasTariffData && (
      <div class="mb-8">
        <h3 class="text-xl font-semibold text-slate-800 mb-4 flex items-center gap-2">
          <span class="text-2xl">üèõÔ∏è</span> Import Tariffs (Food Service Products)
        </h3>
        <div class="bg-gradient-to-br from-purple-50 to-slate-50 rounded-xl border border-purple-200 overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-purple-100/50">
                <tr>
                  <th class="px-4 py-3 text-left font-semibold text-slate-700">Product</th>
                  <th class="px-4 py-3 text-left font-semibold text-slate-700 hidden md:table-cell">HTS Code</th>
                  <th class="px-4 py-3 text-left font-semibold text-slate-700">Origin</th>
                  <th class="px-4 py-3 text-right font-semibold text-slate-700 hidden lg:table-cell">General</th>
                  <th class="px-4 py-3 text-right font-semibold text-slate-700 hidden lg:table-cell">Sec. 301</th>
                  <th class="px-4 py-3 text-right font-semibold text-slate-700">AD/CVD</th>
                  <th class="px-4 py-3 text-right font-semibold text-slate-700 bg-purple-100">Total</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-200">
                {marketData.tariffs.examples.map((tariff, index) => (
                  <tr class={index % 2 === 0 ? 'bg-white' : 'bg-slate-50/50'}>
                    <td class="px-4 py-3 font-medium text-slate-900">
                      <div>{tariff.product}</div>
                      {tariff.notes && (
                        <div class="text-xs text-slate-500 mt-0.5">{tariff.notes}</div>
                      )}
                    </td>
                    <td class="px-4 py-3 text-slate-600 font-mono text-xs hidden md:table-cell">{tariff.htsCode}</td>
                    <td class="px-4 py-3 text-slate-600">{tariff.countryOfOrigin}</td>
                    <td class="px-4 py-3 text-right text-slate-600 hidden lg:table-cell">{tariff.generalRate}</td>
                    <td class="px-4 py-3 text-right text-slate-600 hidden lg:table-cell">
                      {tariff.section301Rate === 'N/A' ? (
                        <span class="text-slate-400">‚Äî</span>
                      ) : (
                        <span class="text-red-600">{tariff.section301Rate}</span>
                      )}
                    </td>
                    <td class="px-4 py-3 text-right">
                      {tariff.adCvdRate === 'N/A' ? (
                        <span class="text-slate-400">‚Äî</span>
                      ) : (
                        <span class="text-orange-600 font-medium">{tariff.adCvdRate}</span>
                      )}
                    </td>
                    <td class={`px-4 py-3 text-right font-bold ${tariff.totalRate === 'Free' ? 'text-green-600' : parseFloat(tariff.totalRate) > 100 ? 'text-red-700' : 'text-slate-900'}`}>
                      {tariff.totalRate}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
          <div class="px-4 py-3 bg-slate-50 border-t border-slate-200">
            <p class="text-xs text-slate-500">
              Source: {marketData.tariffs.source} | Effective: {marketData.tariffs.effectiveDate}
            </p>
          </div>
        </div>
      </div>
    )}

    <!-- Footer with sources -->
    <div class="text-center">
      <p class="text-sm text-slate-500">
        Last updated: {formattedTime} | Data sources: USDA LMPR, USDA ERS, EIA, Freightos Baltic Index, ATRI, USITC
      </p>
    </div>
  </div>
</section>
