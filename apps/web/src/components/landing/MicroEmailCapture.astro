---
/**
 * MicroEmailCapture.astro
 * An inline email-only capture form for newsletter/market updates signup
 *
 * Props:
 * - headline: string - Form headline (e.g., "Get weekly market updates")
 * - subtext: string - Supporting text (e.g., "Join 2,400+ food service operators...")
 * - buttonText: string - Submit button text (e.g., "Subscribe")
 * - source: string - Tracking source identifier (e.g., "market_dashboard")
 */

interface Props {
  headline: string;
  subtext: string;
  buttonText: string;
  source: string;
}

const { headline, subtext, buttonText, source } = Astro.props;

// Generate unique form ID for JavaScript targeting
const formId = `email-capture-${source.replace(/[^a-z0-9]/gi, '-')}`;
---

<div class="bg-slate-100 rounded-xl p-6 border border-slate-200">
  <form
    id={formId}
    action="/api/subscribe"
    method="POST"
    class="email-capture-form"
  >
    <div class="flex items-center gap-2 mb-3">
      <span class="text-xl" aria-hidden="true">{'\u{1F4E7}'}</span>
      <h3 class="text-lg font-semibold text-slate-900">{headline}</h3>
    </div>

    <div class="flex flex-col sm:flex-row gap-3 mb-3">
      <input
        type="email"
        name="email"
        required
        placeholder="email@example.com"
        class="flex-1 px-4 py-2.5 rounded-lg border border-slate-300 bg-white text-slate-900 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
        autocomplete="email"
      />
      <input type="hidden" name="source" value={source} />
      <button
        type="submit"
        class="px-6 py-2.5 bg-primary-600 hover:bg-primary-700 text-white font-medium rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 whitespace-nowrap"
      >
        {buttonText}
      </button>
    </div>

    <p class="text-sm text-slate-600">{subtext}</p>

    <!-- Success message (hidden by default) -->
    <div class="success-message hidden mt-4 p-3 bg-green-100 border border-green-200 rounded-lg">
      <p class="text-green-800 font-medium flex items-center gap-2">
        <span aria-hidden="true">{'\u2713'}</span>
        You're subscribed! Check your inbox for confirmation.
      </p>
    </div>

    <!-- Error message (hidden by default) -->
    <div class="error-message hidden mt-4 p-3 bg-red-100 border border-red-200 rounded-lg">
      <p class="text-red-800 font-medium">
        Something went wrong. Please try again.
      </p>
    </div>
  </form>
</div>

<script>
  // Handle form submission with JavaScript
  document.querySelectorAll('.email-capture-form').forEach((form) => {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formElement = e.target as HTMLFormElement;
      const formData = new FormData(formElement);
      const submitButton = formElement.querySelector('button[type="submit"]') as HTMLButtonElement;
      const successMessage = formElement.querySelector('.success-message') as HTMLElement;
      const errorMessage = formElement.querySelector('.error-message') as HTMLElement;

      // Disable button and show loading state
      const originalText = submitButton.textContent;
      submitButton.disabled = true;
      submitButton.textContent = 'Subscribing...';

      // Hide previous messages
      successMessage?.classList.add('hidden');
      errorMessage?.classList.add('hidden');

      try {
        const response = await fetch(formElement.action, {
          method: 'POST',
          body: formData,
        });

        if (response.ok) {
          // Show success message
          successMessage?.classList.remove('hidden');
          formElement.reset();
        } else {
          // Show error message
          errorMessage?.classList.remove('hidden');
        }
      } catch (error) {
        // Show error message
        errorMessage?.classList.remove('hidden');
      } finally {
        // Restore button state
        submitButton.disabled = false;
        submitButton.textContent = originalText;
      }
    });
  });
</script>
