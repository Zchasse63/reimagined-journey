---
/**
 * City Landing Page - Phase 6 Restructure
 *
 * This page displays all city-specific content with the new component structure:
 * 1. RecallAlertBar (sticky top)
 * 2. HeroWithMarketSnapshot (enhanced hero)
 * 3. DeliveryInfoBar (with fuel surcharge)
 * 4. MarketDashboard (full market intelligence)
 * 5. CostCalculator (interactive savings calculator)
 * 6. MultiStepLeadForm (moved up from bottom!)
 * 7. ValuePropositions (moved down)
 * 8. ProductCategories
 * 9. RecallsSection (full recalls with micro-capture)
 * 10. LocalMarketSection
 * 11. SocialProof
 * 12. NearbyCities
 * 13. FooterCTA
 *
 * Persistent Elements:
 * - StickyLeadCapture (React, client:idle)
 * - ExitIntentPopup (React, client:idle)
 */

export const prerender = false; // Enable SSR for fresh data

// Layout
import CityLayout from '@/layouts/CityLayout.astro';

// Landing Page Components (Astro)
import RecallAlertBar from '@/components/landing/RecallAlertBar.astro';
import HeroWithMarketSnapshot from '@/components/landing/HeroWithMarketSnapshot.astro';
import DeliveryInfoBar from '@/components/landing/DeliveryInfoBar.astro';
import MarketDashboard from '@/components/landing/MarketDashboard.astro';
import ValuePropositions from '@/components/landing/ValuePropositions.astro';
import ProductCategories from '@/components/landing/ProductCategories.astro';
import RecallsSection from '@/components/landing/RecallsSection.astro';
import LocalMarketSection from '@/components/landing/LocalMarketSection.astro';
import SocialProof from '@/components/landing/SocialProof.astro';
import NearbyCities from '@/components/landing/NearbyCities.astro';
import FooterCTA from '@/components/landing/FooterCTA.astro';

// Landing Page Components (React)
import CostCalculator from '@/components/landing/CostCalculator';
import MultiStepLeadForm from '@/components/landing/MultiStepLeadForm';
import StickyLeadCapture from '@/components/landing/StickyLeadCapture';
import ExitIntentPopup from '@/components/landing/ExitIntentPopup';

// Data utilities
import { fetchMarketData, FALLBACK_MARKET_DATA } from '@/lib/market-data';
import { fetchRecalls, FALLBACK_RECALLS } from '@/lib/recalls';
import {
  getAllCities,
  getNearbyCities,
  getTierConfig,
  type CityDataWithSlug,
} from '@value-source/data';

// Types
import type { MarketData } from '@/types/market-data';
import type { Recall } from '@/types/recalls';

// Static paths generation
export function getStaticPaths() {
  const cities = getAllCities();
  return cities.map((city) => ({
    params: {
      state: city.state_slug,
      city: city.slug,
    },
    props: { city },
  }));
}

// Props interface
interface Props {
  city: CityDataWithSlug;
}

// Get city data from props
const { city } = Astro.props;
const tierConfig = getTierConfig(city.tier);
const nearbyCities = getNearbyCities(city, 4);

// Parse distance from Atlanta for calculations
const distanceFromAtlanta = parseInt(
  city.distance_from_atlanta?.replace(/[^0-9]/g, '') || '0'
);

// Determine delivery icon based on tier
const deliveryIcon: 'warehouse' | 'truck' | 'freight' =
  city.tier === 'Hub'
    ? 'warehouse'
    : city.tier.includes('Route')
      ? 'truck'
      : 'freight';

// Fetch dynamic data with fallbacks
let marketData: MarketData = FALLBACK_MARKET_DATA;
let recalls: Recall[] = FALLBACK_RECALLS;

try {
  const marketResponse = await fetchMarketData();
  if (marketResponse.data) {
    marketData = marketResponse.data;
  }
} catch (e) {
  console.error('Market data fetch failed:', e);
}

try {
  const recallsResponse = await fetchRecalls(city.state_abbr);
  if (recallsResponse.recalls) {
    recalls = recallsResponse.recalls;
  }
} catch (e) {
  console.error('Recalls fetch failed:', e);
}

// Trust badges configuration
const trustBadges = {
  yearsInBusiness: 15,
  customersServed: 500,
  onTimeRate: '98%',
};

// Phone number configuration
const phoneNumber = '(800) 555-1234';
---

<CityLayout city={city}>
  <!-- 1. RecallAlertBar (sticky top) -->
  <RecallAlertBar recalls={recalls} state={city.state} />

  <!-- 2. HeroWithMarketSnapshot -->
  <HeroWithMarketSnapshot
    city={city.city}
    state={city.state}
    stateAbbr={city.state_abbr}
    subheadline={tierConfig.heroSubhead}
    trustBadges={trustBadges}
    marketData={marketData}
  />

  <!-- 3. DeliveryInfoBar -->
  <DeliveryInfoBar
    deliveryMethod={tierConfig.deliveryInfo.method}
    deliveryIcon={deliveryIcon}
    deliveryFrequency={tierConfig.deliveryInfo.frequency}
    leadTime={tierConfig.deliveryInfo.leadTime}
    minimumOrder={city.minimum_order}
    dieselPrice={marketData.diesel?.price || 3.5}
  />

  <!-- 4. MarketDashboard (with anchor for navigation) -->
  <div id="market-data">
    <MarketDashboard
      city={city.city}
      marketData={marketData}
      distanceFromAtlanta={distanceFromAtlanta}
    />
  </div>

  <!-- 5. CostCalculator (React component) -->
  <CostCalculator
    client:visible
    city={city.city}
    state={city.state}
    distanceFromAtlanta={distanceFromAtlanta}
    dieselPrice={marketData.diesel?.price || 3.5}
  />

  <!-- 6. MultiStepLeadForm (React component, moved up!) -->
  <MultiStepLeadForm
    client:visible
    city={city.city}
    state={city.state}
    minimumOrder={city.minimum_order}
  />

  <!-- 7. ValuePropositions -->
  <ValuePropositions city={city.city} tier={city.tier} tierConfig={tierConfig} />

  <!-- 8. ProductCategories -->
  <ProductCategories
    city={city.city}
    state={city.state}
    ecoEmphasis={city.eco_emphasis}
  />

  <!-- 9. RecallsSection (with anchor for navigation) -->
  <div id="recalls-section">
    <RecallsSection recalls={recalls} state={city.state} />
  </div>

  <!-- 10. LocalMarketSection -->
  <LocalMarketSection city={city} tierConfig={tierConfig} />

  <!-- 11. SocialProof -->
  <SocialProof state={city.state} />

  <!-- 12. NearbyCities -->
  <NearbyCities
    currentCity={city.city}
    stateSlug={city.state_slug}
    nearbyCities={nearbyCities}
  />

  <!-- 13. FooterCTA -->
  <div id="quote">
    <FooterCTA phoneNumber={phoneNumber} />
  </div>

  <!-- Persistent Elements -->
  <!-- StickyLeadCapture - shows after scrolling past hero, hides near footer -->
  <StickyLeadCapture client:idle phoneNumber={phoneNumber} />

  <!-- ExitIntentPopup - shows when user moves mouse towards closing tab -->
  <ExitIntentPopup client:idle city={city.city} />
</CityLayout>
