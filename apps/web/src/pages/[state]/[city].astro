---
/**
 * City Landing Page - Conversion Optimized
 *
 * This page displays all city-specific content with optimized ordering:
 * 1. RecallAlertBar (sticky top)
 * 2. HeroWithMarketSnapshot (enhanced hero)
 * 3. DeliveryInfoBar (with fuel surcharge)
 * 4. MarketDashboard (full market intelligence)
 * 5. MultiStepLeadForm (lead capture - moved up for conversions!)
 * 6. FreightCalculator (interactive freight estimation)
 * 7. HistoricalCharts (30/60/90 day trends)
 * 8. SeasonalInsights
 * 9. ValuePropositions
 * 10. ProductCategories
 * 11. RecallsSection (full recalls with micro-capture)
 * 12. LocalMarketSection
 * 13. SocialProof
 * 14. FAQSection (with FAQPage schema)
 * 15. NearbyCities
 * 16. FooterCTA
 *
 * Persistent Elements:
 * - StickyLeadCapture (React, client:idle)
 */

export const prerender = false; // Enable SSR for fresh data

// Layout
import CityLayout from '@/layouts/CityLayout.astro';

// Landing Page Components (Astro)
import RecallAlertBar from '@/components/landing/RecallAlertBar.astro';
import HeroWithMarketSnapshot from '@/components/landing/HeroWithMarketSnapshot.astro';
import DeliveryInfoBar from '@/components/landing/DeliveryInfoBar.astro';
import MarketDashboard from '@/components/landing/MarketDashboard.astro';
import ValuePropositions from '@/components/landing/ValuePropositions.astro';
import ProductCategories from '@/components/landing/ProductCategories.astro';
import RecallsSection from '@/components/landing/RecallsSection.astro';
import LocalMarketSection from '@/components/landing/LocalMarketSection.astro';
import SocialProof from '@/components/landing/SocialProof.astro';
import FAQSection from '@/components/landing/FAQSection.astro';
import NearbyCities from '@/components/landing/NearbyCities.astro';
import FooterCTA from '@/components/landing/FooterCTA.astro';

// Landing Page Components (React)
import FreightCalculator from '@/components/landing/FreightCalculator';
import HistoricalChartsLazy from '@/components/landing/HistoricalChartsLazy';
import SeasonalInsights from '@/components/landing/SeasonalInsights';
import MultiStepLeadForm from '@/components/landing/MultiStepLeadForm';
import StickyLeadCapture from '@/components/landing/StickyLeadCapture';

// Data utilities
import { fetchMarketData, FALLBACK_MARKET_DATA } from '@/lib/market-data';
import { fetchRecalls, FALLBACK_RECALLS } from '@/lib/recalls';
import {
  getAllCities,
  getNearbyCities,
  getTierConfig,
  type CityDataWithSlug,
} from '@value-source/data';

// Types
import type { MarketData } from '@/types/market-data';
import type { Recall } from '@/types/recalls';

// In SSR mode (prerender = false), we look up city data from params
// getStaticPaths is not used in SSR mode
const { state, city: citySlug } = Astro.params;

// Look up city data from the data package
const allCities = getAllCities();
const city = allCities.find(
  (c) => c.state_slug === state && c.slug === citySlug
);

// Return 404 if city not found
if (!city) {
  return Astro.redirect('/404');
}

// Set cache headers for CDN caching (1 hour, stale-while-revalidate for 24 hours)
Astro.response.headers.set('Cache-Control', 's-maxage=3600, stale-while-revalidate=86400');

const tierConfig = getTierConfig(city.tier);
const nearbyCities = getNearbyCities(city, 4);

// Parse distance from Atlanta for calculations
// parseInt naturally stops at the first non-numeric character,
// so "230 miles / 3.5 hours" correctly parses as 230
const distanceFromAtlanta = parseInt(city.distance_from_atlanta || '0', 10);

// Determine delivery icon based on tier
const deliveryIcon: 'warehouse' | 'truck' | 'freight' =
  city.tier === 'Hub'
    ? 'warehouse'
    : city.tier.includes('Route')
      ? 'truck'
      : 'freight';

// Fetch dynamic data with fallbacks
let marketData: MarketData = FALLBACK_MARKET_DATA;
let recalls: Recall[] = FALLBACK_RECALLS;

try {
  const marketResponse = await fetchMarketData();
  if (marketResponse.data) {
    marketData = marketResponse.data;
  }
} catch (e) {
  console.error('Market data fetch failed:', e);
}

try {
  const recallsResponse = await fetchRecalls(city.state_abbr);
  if (recallsResponse.recalls) {
    recalls = recallsResponse.recalls;
  }
} catch (e) {
  console.error('Recalls fetch failed:', e);
}

// Trust badges configuration
const trustBadges = {
  yearsInBusiness: 15,
  customersServed: 500,
  onTimeRate: '98%',
};

// Phone number configuration
const phoneNumber = '(404) 555-1234';
---

<CityLayout city={city}>
  <!-- 1. RecallAlertBar (sticky top) -->
  <RecallAlertBar recalls={recalls} state={city.state} />

  <!-- 2. HeroWithMarketSnapshot -->
  <HeroWithMarketSnapshot
    city={city.city}
    state={city.state}
    stateAbbr={city.state_abbr}
    subheadline={tierConfig.heroSubhead}
    trustBadges={trustBadges}
    marketData={marketData}
  />

  <!-- 3. DeliveryInfoBar -->
  <DeliveryInfoBar
    deliveryMethod={tierConfig.deliveryInfo.method}
    deliveryIcon={deliveryIcon}
    deliveryFrequency={tierConfig.deliveryInfo.frequency}
    leadTime={tierConfig.deliveryInfo.leadTime}
    minimumOrder={city.minimum_order}
    dieselPrice={marketData.diesel?.price || 3.5}
  />

  <!-- 4. MarketDashboard (with anchor for navigation) -->
  <div id="market-data">
    <MarketDashboard
      city={city.city}
      marketData={marketData}
      distanceFromAtlanta={distanceFromAtlanta}
    />
  </div>

  <!-- 5. MultiStepLeadForm (moved higher for better conversion!) -->
  <div id="lead-form">
    <MultiStepLeadForm
      client:visible
      city={city.city}
      state={city.state}
      minimumOrder={city.minimum_order}
    />
  </div>

  <!-- 6. FreightCalculator (interactive freight estimation) -->
  <FreightCalculator
    client:visible
    defaultOrigin="Atlanta, GA"
    defaultDestination={`${city.city}, ${city.state_abbr}`}
    defaultDistance={distanceFromAtlanta}
    dryVanRatePerMile={marketData.trucking?.ratePerMile || 2.26}
    fuelSurchargePercent={marketData.trucking?.fuelSurchargePercent || 43.2}
    dieselPrice={marketData.diesel?.price || 3.50}
  />

  <!-- 7. HistoricalCharts (30/60/90 day trends - lazy loaded) -->
  <HistoricalChartsLazy
    client:visible
    dryVanRate={marketData.trucking?.ratePerMile || 2.26}
    reeferRate={(marketData.trucking?.ratePerMile || 2.26) * 1.25}
    dieselPrice={marketData.diesel?.price || 3.50}
    fuelSurchargePercent={marketData.trucking?.fuelSurchargePercent || 43.2}
  />

  <!-- 8. SeasonalInsights -->
  <SeasonalInsights client:visible />

  <!-- 9. ValuePropositions -->
  <ValuePropositions city={city.city} tier={city.tier} tierConfig={tierConfig} />

  <!-- 8. ProductCategories -->
  <ProductCategories
    city={city.city}
    state={city.state}
    ecoEmphasis={city.eco_emphasis}
  />

  <!-- 9. RecallsSection (with anchor for navigation) -->
  <div id="recalls-section">
    <RecallsSection recalls={recalls} state={city.state} />
  </div>

  <!-- 10. LocalMarketSection -->
  <LocalMarketSection city={city} tierConfig={tierConfig} />

  <!-- 11. SocialProof -->
  <SocialProof state={city.state} />

  <!-- 12. FAQSection -->
  <FAQSection
    city={city.city}
    state={city.state}
    minimumOrder={city.minimum_order}
    deliveryMethod={tierConfig.deliveryInfo.method}
    deliveryFrequency={tierConfig.deliveryInfo.frequency}
    tier={city.tier}
  />

  <!-- 13. NearbyCities -->
  <NearbyCities
    currentCity={city.city}
    stateSlug={city.state_slug}
    nearbyCities={nearbyCities}
  />

  <!-- 13. FooterCTA -->
  <div id="quote">
    <FooterCTA phoneNumber={phoneNumber} />
  </div>

  <!-- Persistent Elements -->
  <!-- StickyLeadCapture - shows after scrolling past hero, hides near footer -->
  <StickyLeadCapture client:idle phoneNumber={phoneNumber} />
</CityLayout>
