# Netlify SSR 404 Investigation Report

**Date**: 2026-01-22
**Astro Version**: ^4.4.0 (apps/web/package.json:26)
**Netlify Adapter**: ^5.5.4 (package.json) / v6.6.4 (actual installed)
**Build Environment**: Turborepo monorepo with base="apps/web"

## Executive Summary

City pages (`/[state]/[city]/`) return 404 on Netlify deployment due to **preferStatic:true configuration in the SSR function** (apps/web/.netlify/v1/functions/ssr/ssr.mjs:10). This setting causes Netlify Functions v2 to prioritize serving static files from CDN over invoking the SSR function. Since city pages use `export const prerender = false` (apps/web/src/pages/[state]/[city].astro:24), no static HTML files are generated at build time. When a request arrives for a city page:

1. Netlify receives request for `/georgia/atlanta/`
2. SSR function config has `preferStatic: true`
3. Netlify CDN checks for static file `dist/georgia/atlanta/index.html`
4. File doesn't exist (city pages are SSR-only)
5. **Netlify returns 404 instead of invoking SSR function**

State pages work because they use `getStaticPaths()` (apps/web/src/pages/[state]/index.astro:22), generating static HTML files that exist in dist/ directory.

**Secondary Issue**: Netlify context-specific build commands (netlify.toml:56-63) execute `npm run build` from apps/web/ directory without navigating to repo root, bypassing Turborepo orchestration.

**Tertiary Issue**: Astro config contains deprecated `output: 'hybrid'` (astro.config.mjs:9) which causes build failures in Astro 4.4.0, though this is masked by cache in current deployment.

---

## Detailed Findings

### 1. Netlify Configuration Analysis

#### Base Directory (netlify.toml:2)
```toml
base = "apps/web"
```
**Status**: ✅ Correct - Sets working directory to apps/web/
**Effect**: Functions discovered at apps/web/.netlify/v1/functions/

#### Build Commands

**Main Build Command** (netlify.toml:3):
```toml
command = "cd ../.. && npm install && npm run build"
```
**Status**: ✅ Correct - Navigates to repo root for Turborepo orchestration

**Context Commands** (netlify.toml:56-63):
```toml
[context.production]
  command = "npm run build"

[context.deploy-preview]
  command = "npm run build"

[context.branch-deploy]
  command = "npm run build"
```
**Status**: ❌ **ISSUE DETECTED**
**Problem**: Commands execute from apps/web/ directory (due to `base = "apps/web"`) without `cd ../..` prefix. This bypasses Turborepo, potentially causing @value-source/data package to not build before @value-source/web imports it.

**Impact**: If Netlify uses context-specific commands during production/preview/branch deploys, builds may fail due to missing workspace dependencies.

#### Redirect Rules (netlify.toml:15-19)
```toml
[[redirects]]
  from = "http://*"
  to = "https://:splat"
  status = 301
  force = true
```
**Status**: ✅ Only HTTPS redirect present, no conflicting rules

---

### 2. Astro SSR Function Setup

#### SSR Function Configuration

**File**: apps/web/.netlify/v1/functions/ssr/ssr.mjs
**Generated by**: @astrojs/netlify@6.6.4 (line 8)

```javascript
export const config = {
  includedFiles: ['**/*'],
  name: 'Astro SSR',
  nodeBundler: 'none',
  generator: '@astrojs/netlify@6.6.4',
  path: '/*',
  preferStatic: true,  // ❌ ROOT CAUSE - Line 10
};
```

**Analysis of preferStatic Behavior**:

When `preferStatic: true` (Netlify Functions v2 config):
1. Request arrives for /georgia/atlanta/
2. Netlify CDN checks if static file exists at dist/georgia/atlanta/index.html
3. **If file exists**: Serve from CDN (fast, cached) ✅
4. **If file doesn't exist**: Return 404 (never invokes function) ❌

**Why this breaks city pages**:
- City pages have `export const prerender = false` (SSR-only)
- No static HTML generated during build
- Netlify looks for static file, doesn't find it, returns 404
- SSR function never invoked despite being deployed

**Why state pages still work**:
- State pages use `getStaticPaths()` (prerender:true by default)
- Static HTML generated at build time: dist/georgia/index.html exists
- Netlify CDN serves static file (preferStatic preference satisfied)

**Path Pattern**: `path: '/*'` correctly catches all routes including /[state]/[city]/

**Function Bundle**: All dependencies properly bundled in apps/web/.netlify/v1/functions/ssr/node_modules/

#### Adapter Version Mismatch

**package.json** (line 15): `"@astrojs/netlify": "^5.5.4"`
**Actual installed** (verified via npm list): `@astrojs/netlify@6.6.4`
**Generated config** (ssr.mjs:8): `generator: '@astrojs/netlify@6.6.4'`

**Finding**: npm installed v6.6.4 despite package.json specifying ^5.5.4. This is likely due to:
1. Manual upgrade at some point without updating package.json
2. npm peer dependency resolution upgrading to satisfy Astro 4.4.0 requirements

**Known Issues with v6.x**: Despite being newer version, @astrojs/netlify v6.6.4 still generates `preferStatic: true` for hybrid output mode. This is the default behavior to optimize performance for mostly-static sites, but breaks SSR-only routes without static fallbacks.

---

### 3. Route Manifest Analysis

**File**: apps/web/.netlify/build/manifest_CqIDp2CT.mjs

#### City Route Configuration

**Route Definition** (extracted from manifest):
```javascript
{
  "route": "/[state]/[city]",
  "isIndex": false,
  "type": "page",
  "pattern": "^\\/([^/]+?)\\/([^/]+?)\\/$",
  "segments": [[{"content":"state","dynamic":true,"spread":false}],[{"content":"city","dynamic":true,"spread":false}]],
  "params": ["state","city"],
  "component": "src/pages/[state]/[city].astro",
  "prerender": false,  // ✅ SSR enabled
  "fallbackRoutes": [],
  "distURL": [],
  "origin": "project",
  "_meta": {"trailingSlash":"always"}
}
```

**Status**: ✅ **Correctly configured**
- `prerender: false` - SSR enabled
- Pattern matches /georgia/atlanta/ with trailing slash
- params array correctly defines state and city variables

**Source Verification** (apps/web/src/pages/[state]/[city].astro:24):
```javascript
export const prerender = false; // Enable SSR for fresh data
```

#### State Route Configuration

**Route Definition** (extracted from manifest):
```javascript
{
  "route": "/[state]",
  "type": "page",
  "pattern": "^\\/([^/]+?)\\/$",
  "params": ["state"],
  "component": "src/pages/[state]/index.astro",
  "prerender": true,  // ✅ Static generation
  "pathname": null,  // Dynamic paths via getStaticPaths
  "_meta": {"trailingSlash":"always"}
}
```

**Status**: ✅ **Correctly configured**

**Source Verification** (apps/web/src/pages/[state]/index.astro:22):
```javascript
export function getStaticPaths() {
  const states = [...]; // All states
  return states.map(state => ({ params: { state: state.slug } }));
}
```

State pages use getStaticPaths() which triggers static HTML generation for all states at build time.

---

### 4. Build Output Structure

#### Static Files Generated

**State Pages** (verified via ls):
```
apps/web/dist/georgia/index.html  ✅ (39,285 bytes)
apps/web/dist/florida/index.html  ✅
apps/web/dist/texas/index.html    ✅
... (all states have index.html)
```

**City Pages** (verified via ls):
```
apps/web/dist/georgia/atlanta/     ❌ Does not exist
apps/web/dist/georgia/savannah/    ❌ Does not exist
```

**Finding**: No HTML files generated for city pages because `prerender: false` disables static generation. This is correct behavior for SSR pages, but combined with `preferStatic: true`, it causes 404s.

#### SSR Function Directory Structure

**Verified structure**:
```
apps/web/.netlify/
├── v1/
│   ├── config.json                   ✅ (Images/headers config)
│   └── functions/
│       └── ssr/
│           ├── ssr.mjs               ❌ preferStatic: true (342 bytes)
│           ├── apps/web/.netlify/build/  ✅ All Astro build artifacts
│           │   ├── entry.mjs         ✅ SSR handler entrypoint
│           │   ├── manifest_CqIDp2CT.mjs  ✅ Route manifest
│           │   └── pages/
│           │       ├── _state_/_city_.astro.mjs  ✅ City page SSR module
│           │       └── _state_.astro.mjs         ✅ State page module
│           └── node_modules/         ✅ All dependencies bundled (53 packages)
```

**Status**: Build artifacts complete and correctly structured. SSR function is properly deployed but misconfigured.

---

### 5. Configuration Compatibility Analysis

#### Astro Configuration Issues

**File**: apps/web/astro.config.mjs:7-13

```javascript
export default defineConfig({
  site: 'https://valuesource.com',
  output: 'hybrid',  // ❌ DEPRECATED in Astro 4.4.0
  trailingSlash: 'always',
  adapter: netlify({
    edgeMiddleware: false,
  }),
  // ...
});
```

**Issue**: `output: 'hybrid'` is deprecated in Astro 4.4.0 and causes build validation to fail:
```
! The output: "hybrid" option has been removed. Use output: "static" (the default) instead, which now behaves the same way.
```

**Why this isn't blocking current deployment**:
- Netlify build cache may be serving old successful build
- OR Netlify uses different Astro version than local environment
- Local builds fail, but deployed version still works (from previous successful build)

**Astro 4+ Hybrid Behavior**:
- Default `output: 'static'` (or omitting output) supports hybrid rendering
- Page-level `export const prerender = false` → SSR (requires adapter)
- Page-level `getStaticPaths()` or `export const prerender = true` → static HTML
- No explicit `output: 'hybrid'` needed - behavior is page-level

#### Adapter Configuration

**Current Settings** (astro.config.mjs:11-13):
```javascript
adapter: netlify({
  edgeMiddleware: false,
}),
```

**Analysis**: The adapter config doesn't expose a `preferStatic` option to override. The adapter internally decides to set `preferStatic: true` based on:
1. Astro output mode (hybrid/static with some SSR pages)
2. Optimization assumption: most pages are static, serve them fast
3. No detection that some routes have NO static fallback

**No way to configure preferStatic through Astro config** - it's hardcoded in adapter build plugin.

#### Trailing Slash Consistency

**Astro config** (astro.config.mjs:10): `trailingSlash: 'always'`
**Route patterns in manifest**: All include trailing slash `\\/`
**SSR function path**: `'/*'` catches both with and without trailing slash

**Status**: ✅ No mismatch - trailing slash configuration is consistent

---

## Recommended Fixes

### Fix 1: Remove Deprecated Astro Config (CRITICAL - Unblocks Builds)

**Priority**: P0 - Blocks local builds and potentially new deployments
**File**: apps/web/astro.config.mjs

**Change Required**: Delete line 9

**Before** (lines 7-13):
```javascript
export default defineConfig({
  site: 'https://valuesource.com',
  output: 'hybrid',  // ❌ REMOVE THIS LINE
  trailingSlash: 'always',
  adapter: netlify({
    edgeMiddleware: false,
  }),
  // ...
});
```

**After**:
```javascript
export default defineConfig({
  site: 'https://valuesource.com',
  // output: 'static' is default - omit the line entirely
  trailingSlash: 'always',
  adapter: netlify({
    edgeMiddleware: false,
  }),
  // ...
});
```

**Why this works**:
- Astro 4+ treats default `output: 'static'` as hybrid-capable
- Page-level prerender settings still respected
- Removes deprecation error blocking builds

**Verification**:
```bash
npm run build
# Should complete without "output: hybrid" error
```

---

### Fix 2: Patch SSR Function to Disable preferStatic (PRIMARY FIX FOR 404s)

**Priority**: P0 - Directly fixes city page 404s
**Problem**: @astrojs/netlify adapter hardcodes `preferStatic: true` with no config option to override

**Solution**: Post-build script to patch generated SSR function

**Step 1**: Create patch script at `apps/web/scripts/patch-ssr-config.mjs`:
```javascript
import { readFile, writeFile } from 'fs/promises';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';

const __dirname = dirname(fileURLToPath(import.meta.url));
const ssrPath = join(__dirname, '../.netlify/v1/functions/ssr/ssr.mjs');

try {
  console.log('Patching SSR function config...');

  const content = await readFile(ssrPath, 'utf-8');

  if (!content.includes('preferStatic')) {
    console.log('✅ No preferStatic setting found (already correct)');
    process.exit(0);
  }

  if (content.includes('preferStatic: false')) {
    console.log('✅ preferStatic already set to false');
    process.exit(0);
  }

  // Replace preferStatic: true with preferStatic: false
  const patched = content.replace(
    /preferStatic:\s*true/g,
    'preferStatic: false'
  );

  if (patched === content) {
    console.error('❌ Failed to find preferStatic: true pattern');
    process.exit(1);
  }

  await writeFile(ssrPath, patched, 'utf-8');
  console.log('✅ Patched preferStatic: true → false in ssr.mjs');
  console.log(`   File: ${ssrPath}`);

} catch (error) {
  console.error('❌ Patch failed:', error.message);
  process.exit(1);
}
```

**Step 2**: Update build script in `apps/web/package.json`:
```json
{
  "scripts": {
    "build": "astro check && astro build && node scripts/patch-ssr-config.mjs"
  }
}
```

**Why this works**:
- Runs after astro build generates SSR function
- Changes `preferStatic: true` → `preferStatic: false`
- Netlify will invoke SSR function for missing static files instead of returning 404
- No changes to adapter source code needed

**Effect**:
- City pages (no static HTML) → invoke SSR function → return 200 ✅
- State pages (static HTML exists) → still serve from CDN first → fast ✅
- API endpoints (SSR-only) → invoke SSR function → work ✅

**Verification**:
```bash
npm run build
# Should show: ✅ Patched preferStatic: true → false

cat apps/web/.netlify/v1/functions/ssr/ssr.mjs | grep preferStatic
# Should show: preferStatic: false
```

---

### Fix 3: Align Netlify Context Build Commands (SECONDARY)

**Priority**: P1 - Required for reliable production/preview builds
**File**: netlify.toml

**Change Required**: Update lines 56-63

**Before**:
```toml
[context.production]
  command = "npm run build"

[context.deploy-preview]
  command = "npm run build"

[context.branch-deploy]
  command = "npm run build"
```

**After**:
```toml
[context.production]
  command = "cd ../.. && npm install && npm run build"

[context.deploy-preview]
  command = "cd ../.. && npm install && npm run build"

[context.branch-deploy]
  command = "cd ../.. && npm install && npm run build"
```

**Why**:
- With `base = "apps/web"`, context commands execute from apps/web/ directory
- Without `cd ../..`, Turborepo orchestration is bypassed
- @value-source/data package won't build before @value-source/web depends on it

**Verification**:
```bash
# Simulate context command from apps/web/ directory
cd apps/web
npm run build
# Should fail or show incomplete build

# Correct command from repo root
cd ../..
npm run build
# Should show both packages building
```

---

### Fix 4: Update package.json Adapter Version (OPTIONAL - Cleanup)

**Priority**: P2 - Documentation cleanup, no functional impact
**File**: apps/web/package.json

**Change Required**: Update line 15

**Before**:
```json
{
  "dependencies": {
    "@astrojs/netlify": "^5.5.4"
  }
}
```

**After**:
```json
{
  "dependencies": {
    "@astrojs/netlify": "^6.6.4"
  }
}
```

**Why**: package.json currently specifies ^5.5.4 but npm installed 6.6.4. Updating package.json documents actual version being used.

**Note**: This doesn't change behavior since 6.6.4 is already installed. It's purely documentation.

---

## Testing Plan

### Phase 1: Fix Local Build (Prerequisite)

**Step 1**: Apply Fix 1 (remove `output: 'hybrid'`)
```bash
# Edit apps/web/astro.config.mjs - delete line 9
```

**Step 2**: Apply Fix 2 (create patch script)
```bash
mkdir -p apps/web/scripts
# Create apps/web/scripts/patch-ssr-config.mjs with content from Fix 2
# Update apps/web/package.json build script
```

**Step 3**: Test build succeeds
```bash
cd /Users/zach/fs-leads/reimagined-journey
npm run build
```

**Expected Output**:
```
✅ Turborepo shows both packages building
✅ No "output: hybrid" deprecation error
✅ Patched preferStatic: true → false in ssr.mjs
✅ Build completes successfully
```

**Step 4**: Verify SSR function patched
```bash
cat apps/web/.netlify/v1/functions/ssr/ssr.mjs | grep preferStatic
# Should show: preferStatic: false
```

---

### Phase 2: Test Local Preview

**Step 1**: Start preview server
```bash
cd apps/web
npm run preview
```

**Step 2**: Test city route (SSR)
```bash
curl -I http://localhost:4321/georgia/atlanta/
# Expected: HTTP/1.1 200 OK (not 404)

curl http://localhost:4321/georgia/atlanta/ | grep -o '<h1>.*</h1>'
# Should show city name and fresh market data
```

**Step 3**: Test state route (static)
```bash
curl -I http://localhost:4321/georgia/
# Expected: HTTP/1.1 200 OK

curl http://localhost:4321/georgia/ | grep -o '<h1>.*</h1>'
# Should show state name
```

**Step 4**: Verify SSR function logs
- Check preview server output for SSR invocation logs when accessing city pages
- Should NOT see 404 errors

---

### Phase 3: Deploy to Netlify

**Step 1**: Apply Fix 3 (context commands)
```bash
# Edit netlify.toml lines 56-63
# Add "cd ../.. && npm install && " prefix to all context commands
```

**Step 2**: Commit and push
```bash
git add apps/web/astro.config.mjs apps/web/package.json apps/web/scripts/patch-ssr-config.mjs netlify.toml
git commit -m "fix: resolve SSR 404s by disabling preferStatic and fixing build config

- Remove deprecated output:'hybrid' from astro.config.mjs (Astro 4.4.0)
- Add post-build script to patch preferStatic: true → false in SSR function
- Update netlify.toml context commands to use Turborepo from repo root
- Fixes city pages returning 404 due to preferStatic blocking SSR invocation

Closes #[issue-number]"
git push
```

**Step 3**: Monitor Netlify build logs
- Verify both @value-source/data and @value-source/web build
- Check for "✅ Patched preferStatic" message
- Confirm build completes successfully
- No "output: hybrid" deprecation error

**Step 4**: Test production city route
```bash
curl -I https://[your-site].netlify.app/georgia/atlanta/
# Expected: HTTP/2 200 (not 404)

curl https://[your-site].netlify.app/georgia/atlanta/ | grep -o '<h1>.*</h1>'
# Should show city name and fresh data
```

**Step 5**: Test production state route (verify static still works)
```bash
curl -I https://[your-site].netlify.app/georgia/
# Expected: HTTP/2 200

# Check response headers for CDN cache
curl -I https://[your-site].netlify.app/georgia/ | grep -i 'x-nf-request-id\|cache'
# Should show CDN cache headers (static file served)
```

**Step 6**: Verify function invocations (Netlify Dashboard)
- Navigate to Netlify Functions tab
- Check "ssr" function exists and shows invocations for city pages
- Verify no 404 errors in function logs
- State pages should have minimal function invocations (served from CDN)

---

## Verification Commands

```bash
# 1. Check Astro config doesn't have output:'hybrid'
grep "output:" apps/web/astro.config.mjs
# Should show NO LINE with output:'hybrid'

# 2. Verify city page has prerender = false
grep "export const prerender" apps/web/src/pages/\[state\]/\[city\].astro
# Should show: export const prerender = false;

# 3. Check package versions
grep '"astro"\|"@astrojs/netlify"' apps/web/package.json

# 4. Verify patch script exists
ls -lh apps/web/scripts/patch-ssr-config.mjs

# 5. After build: Check SSR function has preferStatic: false
grep "preferStatic" apps/web/.netlify/v1/functions/ssr/ssr.mjs
# Should show: preferStatic: false

# 6. After build: Verify route manifest has city route
grep -o '"route":"/\[state\]/\[city\]".*"prerender":false' apps/web/.netlify/build/manifest_*.mjs

# 7. Verify netlify.toml context commands navigate to root
grep -A1 "context.production\|context.deploy-preview" netlify.toml
# Should show: command = "cd ../.. && npm install && npm run build"

# 8. Check no city directories in dist (SSR-only)
ls apps/web/dist/georgia/
# Should show ONLY index.html (state page), no atlanta/ or savannah/ subdirs

# 9. Verify SSR function path pattern
grep '"path"' apps/web/.netlify/v1/functions/ssr/ssr.mjs
# Should show: path: '/*'
```

---

## Summary

### Root Cause

**preferStatic:true configuration** in apps/web/.netlify/v1/functions/ssr/ssr.mjs:10 causes Netlify Functions v2 to prioritize serving static files from CDN over invoking the SSR function. For city pages with `export const prerender = false` (SSR-only), no static HTML files exist in dist/ directory. When Netlify receives requests for city routes:

1. Checks for static file due to preferStatic:true
2. File doesn't exist (SSR page, not prerendered)
3. Returns 404 instead of falling back to SSR function

State pages work because they have static HTML files (generated via getStaticPaths), satisfying preferStatic preference.

### Critical Path to Resolution

1. **Remove `output: 'hybrid'` from astro.config.mjs:9** → Unblocks local builds
2. **Create patch script to set preferStatic: false** → Fixes city page 404s
3. **Update netlify.toml context commands** → Ensures Turborepo orchestration
4. **Test locally with `npm run preview`** → Verify city routes return 200
5. **Deploy to Netlify** → Test production city routes

### Expected Outcome After All Fixes Applied

- ✅ Local builds succeed without deprecation errors
- ✅ SSR function deployed with `preferStatic: false`
- ✅ City pages invoke SSR function and return 200 OK with fresh market data
- ✅ State pages still serve static HTML from CDN (fast, cached)
- ✅ API endpoints continue working (SSR-only)
- ✅ No 404 errors for valid city routes
- ✅ Turborepo builds both workspace packages in correct order

### Technical Details

**Why preferStatic:true was set**: @astrojs/netlify adapter defaults to preferStatic:true for hybrid/static output modes to optimize performance for sites that are mostly static. The adapter assumes if a route has no static file, it's a 404. This assumption breaks for SSR-only routes.

**Why we can't configure it**: The adapter doesn't expose a `preferStatic` option in config. It's hardcoded in the adapter's build plugin based on output mode detection.

**Why post-build patching works**: Netlify reads the function config from ssr.mjs at deploy time. Patching the generated file after astro build but before deployment changes the behavior without modifying adapter source code.

---

**Investigation Status**: COMPLETE
**Root Cause Identified**: YES - preferStatic:true in SSR function config
**Evidence**: apps/web/.netlify/v1/functions/ssr/ssr.mjs:10
**Fix Complexity**: MEDIUM - Requires post-build patching since adapter doesn't expose config
**Recommended Action**: Apply all 4 fixes, test locally, deploy to Netlify
